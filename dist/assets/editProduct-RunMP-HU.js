import{R as U,u as H,r as h,f as W,n as X,b as y,j as e,L as Y,s as g,o as Z,p as ee,v as ae,q as k,t as se,w as re}from"./index-S6-I6USK.js";import{S as te,H as le}from"./header-B8u4Ziyx.js";import{u as ie,C as P,F as ne}from"./index-Dz1OxvFt.js";import{S as L,C as oe}from"./compressor.esm-B2634Ev3.js";import{R as ce}from"./quill.snow-B9oZ-vTs.js";function de(){const{isSidebarHidden:V}=H(),[E,C]=h.useState(!1),[p,b]=h.useState([]),[x,D]=h.useState([]),[f,F]=h.useState([]),[M,R]=h.useState(0),A=W();let{id:_}=X();const{register:j,handleSubmit:$,formState:{errors:l},watch:d,control:w,setValue:u}=ie({mode:"onChange",defaultValues:{categoryId:"",subCategoryId:""}}),{data:i}=y({queryKey:["proDetails",_],queryFn:()=>ae(_),onError:a=>{console.log(a)},select:a=>a.results.product[0]}),{data:B}=y({queryKey:["categoryList"],queryFn:async()=>k({page:1,pageSize:1e3,categoryId:"",allSubcategory:!1,search:""}),onError:a=>{console.log(a)}}),q=B?.results?.categories||[],{data:z}=y({queryKey:["subCategoryList",d("categoryId")],queryFn:async()=>{const a={page:1,pageSize:1e3,categoryId:d("categoryId"),allSubcategory:!0,search:""};return k(a)},enabled:!!d("categoryId"),onError:a=>{console.log(a)}}),S=z?.results?.categories||[],{data:G}=y({queryKey:["attList"],queryFn:async()=>se({page:1,pageSize:1e3,search:""}),onError:a=>{console.log(a)}}),v=G?.results?.attributes||[],{data:K}=y({queryKey:["valueList",d("attributeId")],queryFn:async()=>{const a={page:1,pageSize:1e3,attributeIds:d("attributeId"),search:""};return re(a)},enabled:!!d("attributeId"),onError:a=>{console.log(a)}}),N=K?.results?.values||[],I=h.useRef(null);h.useEffect(()=>{i?.images&&i.images.length>0&&F(i.images)},[i]),h.useEffect(()=>{i?.name_en&&q?.length>0&&(u("name_en",i?.name_en),u("type",i?.type),u("calories",i?.calories),u("description_en",i?.description_en),u("categoryId",i?.categoryId?._id),I.current===null&&(I.current=i?.categoryId?._id),S?.length>0&&u("subCategoryId",i?.subCategoryId?._id))},[i,q,S,u]),h.useEffect(()=>{const a=d("categoryId");I.current!==null&&a!==I.current&&u("subCategoryId","")},[d("categoryId"),u]),h.useEffect(()=>{if(i?.name_en&&i?.variants?.length&&v?.length){const a=i.variants.flatMap(s=>s.combination?.map(r=>r.attributeId?._id)).filter(s=>s&&s!==void 0).filter((s,r,n)=>n.indexOf(s)===r);a.length>0&&u("attributeId",a)}},[i,v,u]),h.useEffect(()=>{if(i?.name_en&&i?.variants?.length&&d("attributeId")?.length&&N?.length){const a=i.variants.flatMap(r=>r.combination?.map(n=>n.valueId?._id)).filter(r=>r&&r!==void 0).filter((r,n,t)=>t.indexOf(r)===n);a.length>0&&u("valueId",a);const s=i.variants.map(r=>!r.combination||r.combination.length===0?null:r.combination.map(n=>({_id:r._id,attributeId:n.attributeId?._id,valueId:n.valueId?._id,attributeName:n.attributeId?.name_en,valueName:n.valueId?.name_en,price:r.price,discountPrice:r.discountPrice,quantity:r.quantity}))).filter(Boolean);s.length>0&&b(s)}},[i,d("attributeId"),N,u]);const O=async()=>{if(!d("attributeId")?.length&&!d("valueId")?.length){g("Please select attribute & value","error");return}console.log(d("attributeId"),d("valueId"));const a={selectedAttributes:d("attributeId"),selectedValues:d("valueId")};try{const s=await Z(a);s.error?g(s.message,"error"):b(s.results.combinations)}catch{console.log("An error occurred")}finally{C(!1)}},J=async a=>{if(f.length+x.length<5){g("Please upload at least 5 images","error");return}const r=p.flatMap(o=>o.filter(m=>!m.quantity||!m.price||!m.discountPrice));if(p.flatMap(o=>o.filter(m=>Number(m.discountPrice)>Number(m.price))).length>0)return;if(r.length>0){g("Please fill all required fields for variations","error");return}C(!0);const t=new FormData;t.append("name_en",a.name_en),t.append("description_en",a.description_en),t.append("categoryId",a.categoryId),t.append("subCategoryId",a.subCategoryId),t.append("calories",a.calories),t.append("type",a.type),f.length>0&&t.append("existingImages",JSON.stringify(f)),x.forEach(o=>{t.append("images",o)});const c=p.flat().map(o=>({_id:o._id,quantity:o.quantity||0,price:o.price||0,discountPrice:o.discountPrice||0,combination:[{attributeId:o.attributeId,valueId:o.valueId}]}));t.append("variants",JSON.stringify(c));try{const o=await ee(_,t,m=>{R(Math.round(100*m.loaded/m.total))});o.error?g(o.message,"error"):(g(o.message,"success"),A("/merchant/products"))}catch{console.log("An error occurred")}finally{C(!1)}},Q=a=>{const s=Array.from(a.target.files),r=5*1024*1024;let n=!1;s.forEach(t=>{if(t.size>r){n=!0;return}new oe(t,{quality:.6,success(c){D(o=>[...o,c])},error(c){g(`Failed to compress ${t.name}`,"error")}})}),n&&g("Some files exceed 5MB limit and were not added","error"),a.target.value=""},T=a=>{const s=x.filter((r,n)=>n!==a);D(s)};return console.log(p),e.jsx(e.Fragment,{children:e.jsxs("div",{className:"admin-wrapper d-flex",children:[e.jsx(te,{}),e.jsxs("div",{className:V?"main-content flex-grow-1 full":"main-content flex-grow-1",id:"main-content",children:[e.jsx(le,{}),e.jsx("main",{className:"p-4",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"d-flex gap-3 align-items-center justify-content-between",children:[e.jsx("h3",{className:"fw-semibold fs-5",children:" Add Product"}),e.jsxs(Y,{to:"",onClick:()=>A(-1),className:"btn btn-sm btn-light",children:[e.jsx("i",{className:"fa fa-arrow-left me-2"})," Go Back"]})]})}),e.jsx("div",{className:"card-body",children:e.jsx("form",{onSubmit:$(J),children:e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"w-100",children:[e.jsxs("div",{className:"upload-img",children:[e.jsx("input",{type:"file",id:"productImage",className:"d-none",accept:"image/*",multiple:!0,onChange:Q}),e.jsxs("label",{htmlFor:"productImage",className:"upload-content",children:[e.jsx("i",{className:"fa fa-cloud-upload"}),e.jsxs("p",{className:"mb-0",children:[" ","Click to upload at least 5 images"]}),e.jsx("small",{className:"text-muted",children:"PNG, JPG, JPEG (Max 5MB)"})]})]}),(f.length>0||x.length>0)&&e.jsxs("div",{className:"row mt-3 g-2",children:[f.map((a,s)=>e.jsxs("div",{className:"col-3 position-relative img-wrap",children:[e.jsx("img",{src:a,alt:`Existing ${s+1}`,className:"img-fluid rounded shadow-sm",style:{width:"100%",height:"100px",objectFit:"cover"}}),e.jsx("i",{className:"fas fa-remove",onClick:()=>{const r=f.filter((n,t)=>t!==s);F(r)}})]},`existing-${s}`)),x.map((a,s)=>e.jsxs("div",{className:"col-3 position-relative img-wrap",children:[e.jsx("img",{src:URL.createObjectURL(a),alt:`Preview ${s+1}`,className:"img-fluid rounded shadow-sm",style:{width:"100%",height:"100px",objectFit:"cover"}}),e.jsx("i",{className:"fas fa-remove",onClick:()=>T(s)})]},`new-${s}`))]})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Product Name"}),e.jsx("input",{type:"text",placeholder:"Enter product name",className:`form-control ${l.name_en?"input-error":""}`,...j("name_en",{required:"Product Name is required"})}),l.name_en&&e.jsx("p",{className:"form-error",children:l.name_en.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Category"}),e.jsxs("select",{className:`form-control form-select ${l.categoryId?"input-error":""}`,...j("categoryId",{required:"Category  is required"}),children:[e.jsx("option",{value:"",hidden:!0,children:"Select Category"}),q?.map(a=>e.jsx("option",{value:a._id,children:a.name_en},a._id))]}),l.categoryId&&e.jsx("p",{className:"form-error",children:l.categoryId.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Subcategory"}),e.jsxs("select",{className:`form-control form-select ${l.subCategoryId?"input-error":""}`,...j("subCategoryId",{required:"Sub Category  is required"}),children:[e.jsx("option",{hidden:!0,value:"",children:"Select Sub Category"}),S?.map(a=>e.jsx("option",{value:a._id,children:a.name_en},a._id))]}),l.subCategoryId&&e.jsx("p",{className:"form-error",children:l.subCategoryId.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Calories"}),e.jsx("input",{type:"number",placeholder:"Enter calories",className:`form-control ${l.calories?"input-error":""}`,...j("calories",{required:!1})}),l.calories&&e.jsx("p",{className:"form-error",children:l.calories.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:`form-control form-select ${l.type?"input-error":""}`,...j("type",{required:"Type is required"}),children:[e.jsx("option",{value:"",hidden:!0,children:"Select Type"}),e.jsx("option",{value:"Veg",children:"Veg"}),e.jsx("option",{value:"Non Veg",children:"Non-Veg"})]}),l.type&&e.jsx("p",{className:"form-error",children:l.type.message})]}),e.jsxs("div",{className:"col-md-12 ReactQuill",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx(P,{name:"description_en",control:w,rules:{required:"Description is required",validate:a=>(a?.replace(/<[^>]*>/g,"").trim()).length>0||"Description is required"},render:({field:a})=>e.jsx(ce,{theme:"snow",value:a.value||"",onChange:s=>{a.onChange(s),s.replace(/<[^>]*>/g,"").trim()===""&&a.onChange("")},onBlur:()=>{a.onBlur()},placeholder:"Enter description",className:l.description_en?"input-error":"",style:{height:"130px",marginBottom:"65px"},modules:{toolbar:[[{header:[1,2,3,4,5,6,!1]}],[{font:[]}],[{size:["small",!1,"large","huge"]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{script:"sub"},{script:"super"}],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{align:[]}],["blockquote","code-block"],["clean"]]}})}),l.description_en&&e.jsx("p",{className:"form-error",style:{marginTop:"75px"},children:l.description_en.message})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("h2",{className:"fs-5 fw-bold",children:"Create Attribute"}),e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-5 multi",children:[e.jsx("label",{className:"form-label",children:"Attribute "}),e.jsx(P,{name:"attributeId",control:w,rules:{required:"Attribute is required"},render:({field:a})=>e.jsx(L,{...a,isMulti:!0,options:v?.map(s=>({value:s._id,label:s.name_en})),placeholder:"Select Attribute",className:l.attributeId?"react-select-error":"",classNamePrefix:"react-select",onChange:s=>a.onChange(s?.map(r=>r.value)||[]),value:v?.filter(s=>a.value?.includes(s._id)).map(s=>({value:s._id,label:s.name_en}))||[]})}),l.attributeId&&e.jsx("p",{className:"form-error",children:l.attributeId.message})]}),e.jsxs("div",{className:"col-md-5 multi",children:[e.jsx("label",{className:"form-label",children:"Value"}),e.jsx(P,{name:"valueId",control:w,rules:{required:"Value is required"},render:({field:a})=>e.jsx(L,{...a,isMulti:!0,options:N?.map(s=>({value:s._id,label:s.name_en})),placeholder:"Select Value",className:l.valueId?"react-select-error":"",classNamePrefix:"react-select",onChange:s=>a.onChange(s?.map(r=>r.value)||[]),value:N?.filter(s=>a.value?.includes(s._id)).map(s=>({value:s._id,label:s.name_en}))||[]})}),l.valueId&&e.jsx("p",{className:"form-error",children:l.valueId.message})]}),e.jsx("div",{className:"col-md-auto pt-4",children:e.jsx("button",{onClick:a=>{a.preventDefault(),O()},className:"comman-btn-main w-100 fs-6 mt-1",children:"Show Combination"})}),p?.length?e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card shadow",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"fw-semibold fs-5",children:"Attribute"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"table-responsive shadow-sm rounded bg-white p-3",children:e.jsxs("table",{className:"table table-hover align-middle",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"Attribute Name"}),e.jsx("th",{children:"Combination"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Discounted Price"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{className:"text-center",children:"Actions"})]})}),e.jsx("tbody",{children:p?.map((a,s)=>a?.map((r,n)=>e.jsxs("tr",{children:[e.jsx("td",{children:r.attributeName}),e.jsx("td",{children:e.jsx("div",{className:"badge bg-main",children:r.valueName})}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"form-control small-width",value:r.price||"",onChange:t=>{const c=[...p];c[s][n].price=t.target.value,b(c)}})}),e.jsxs("td",{children:[e.jsx("input",{type:"number",className:"form-control small-width",value:r.discountPrice||"",onChange:t=>{const c=[...p];c[s][n].discountPrice=t.target.value,b(c)}}),Number(r.discountPrice)>=Number(r.price)&&e.jsx("p",{className:"form-error",children:"Discounted price cannot be greater than base price"})]}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"form-control small-width",value:r.quantity||"",onChange:t=>{const c=[...p];c[s][n].quantity=t.target.value,b(c)}})}),e.jsx("td",{className:"text-center",children:e.jsx("button",{className:"table-btn bg-danger",onClick:t=>{t.preventDefault();const c=[...p];c[s]=c[s].filter((o,m)=>m!==n),b(c)},children:e.jsx("i",{className:"fa fa-trash"})})})]},r._id)))})]})})})]})}):""]})})]}),e.jsx("div",{className:"col-12 mt-4",children:e.jsx("button",{type:"submit",className:"btn comman-btn-main",disabled:E,children:E?e.jsxs(e.Fragment,{children:[e.jsx(ne,{strokeColor:"white",strokeWidth:"5",animationDuration:"0.75",width:"20",visible:!0}),e.jsxs("span",{className:"ms-2",children:[" Wait... ",M,"%"]})]}):"Add"})})]})})})]})})]})]})})}const be=U.memo(de);export{be as default};
