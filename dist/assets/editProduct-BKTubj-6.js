import{R as H,u as Q,a as u,b as W,f as X,h as j,j as e,L as Y,s as h,i as Z,k as ee,v as se,l as k,m as ae,n as re}from"./index-DA83-y1t.js";import{S as te,H as le}from"./sideBar-D8n15IYi.js";import{u as ne,C as S,F as ie}from"./index-CJFlnJSs.js";import{R as oe,S as L,C as ce}from"./quill.snow-BN5jiBeW.js";function de(){const{isSidebarHidden:V}=Q(),[P,I]=u.useState(!1),[m,g]=u.useState(!1),[f,E]=u.useState([]),[p,D]=u.useState([]),[$,R]=u.useState(0),F=W();let{id:C}=X();const{register:x,handleSubmit:M,formState:{errors:l},watch:c,control:_,setValue:d}=ne({mode:"onChange",defaultValues:{categoryId:"",subCategoryId:""}}),{data:n}=j({queryKey:["proDetails",C],queryFn:()=>se(C),onError:s=>{console.log(s)},select:s=>s.results.product[0]}),{data:B}=j({queryKey:["categoryList"],queryFn:async()=>k({page:1,pageSize:1e3,categoryId:"",allSubcategory:!1,search:""}),onError:s=>{console.log(s)}}),w=B?.results?.categories||[],{data:z}=j({queryKey:["subCategoryList",c("categoryId")],queryFn:async()=>{const s={page:1,pageSize:1e3,categoryId:c("categoryId"),allSubcategory:!0,search:""};return k(s)},enabled:!!c("categoryId"),onError:s=>{console.log(s)}}),q=z?.results?.categories||[],{data:G}=j({queryKey:["attList"],queryFn:async()=>ae({page:1,pageSize:1e3,search:""}),onError:s=>{console.log(s)}}),y=G?.results?.attributes||[],{data:K}=j({queryKey:["valueList",c("attributeId")],queryFn:async()=>{const s={page:1,pageSize:1e3,attributeIds:c("attributeId"),search:""};return re(s)},enabled:!!c("attributeId"),onError:s=>{console.log(s)}}),N=K?.results?.values||[],v=u.useRef(null);u.useEffect(()=>{n?.images&&n.images.length>0&&D(n.images)},[n]),u.useEffect(()=>{n?.name_en&&w?.length>0&&(d("name_en",n?.name_en),d("type",n?.type),d("calories",n?.calories),d("description_en",n?.description_en),d("categoryId",n?.categoryId?._id),v.current===null&&(v.current=n?.categoryId?._id),q?.length>0&&d("subCategoryId",n?.subCategoryId?._id))},[n,w,q,d]),u.useEffect(()=>{const s=c("categoryId");v.current!==null&&s!==v.current&&d("subCategoryId","")},[c("categoryId"),d]),u.useEffect(()=>{if(n?.name_en&&n?.variants?.length&&y?.length){const s=n.variants.flatMap(a=>a.combination?.map(r=>r.attributeId?._id)).filter(a=>a&&a!==void 0).filter((a,r,t)=>t.indexOf(a)===r);s.length>0&&d("attributeId",s)}},[n,y,d]),u.useEffect(()=>{if(n?.name_en&&n?.variants?.length&&c("attributeId")?.length&&N?.length){const s=n.variants.flatMap(r=>r.combination?.map(t=>t.valueId?._id)).filter(r=>r&&r!==void 0).filter((r,t,o)=>o.indexOf(r)===t);s.length>0&&d("valueId",s);const a=n.variants.map(r=>r.combination?.[0]?{attributeId:r.combination[0].attributeId?._id,valueId:r.combination[0].valueId?._id,attributeName:r.combination[0].attributeId?.name_en,valueName:r.combination[0].valueId?.name_en,price:r.price,discountPrice:r.discountPrice,quantity:r.quantity}:null).filter(Boolean);a.length>0&&g(a)}},[n,c("attributeId"),N,d]);const O=async()=>{if(!c("attributeId")?.length&&!c("valueId")?.length){h("Please select attribute & value","error");return}console.log(c("attributeId"),c("valueId"));const s={selectedAttributes:c("attributeId"),selectedValues:c("valueId")};try{const a=await Z(s);a.error?h(a.message,"error"):g(a.results.combinations[0])}catch{console.log("An error occurred")}finally{I(!1)}},J=async s=>{if(p.length+f.length<5){h("Please upload at least 5 images","error");return}const r=m.filter(i=>!i.quantity||!i.price||!i.discountPrice);if(m.filter(i=>Number(i.discountPrice)>Number(i.price)).length>0)return;if(r.length>0){h("Please fill all required fields for variations","error");return}I(!0);const o=new FormData;o.append("name_en",s.name_en),o.append("description_en",s.description_en),o.append("categoryId",s.categoryId),o.append("subCategoryId",s.subCategoryId),o.append("calories",s.calories),o.append("type",s.type),p.length>0&&o.append("existingImages",JSON.stringify(p)),f.forEach(i=>{o.append("images",i)});const b=m.map(i=>({quantity:i.quantity||0,price:i.price||0,discountPrice:i.discountPrice||0,combination:[{attributeId:i.attributeId,valueId:i.valueId}]}));o.append("variants",JSON.stringify(b));try{const i=await ee(C,o,A=>{R(Math.round(100*A.loaded/A.total))});i.error?h(i.message,"error"):(h(i.message,"success"),F("/merchant/products"))}catch{console.log("An error occurred")}finally{I(!1)}},T=s=>{const a=Array.from(s.target.files),r=5*1024*1024;let t=!1;a.forEach(o=>{if(o.size>r){t=!0;return}new ce(o,{quality:.6,success(b){E(i=>[...i,b])},error(b){h(`Failed to compress ${o.name}`,"error")}})}),t&&h("Some files exceed 5MB limit and were not added","error"),s.target.value=""},U=s=>{const a=f.filter((r,t)=>t!==s);E(a)};return console.log(m),e.jsx(e.Fragment,{children:e.jsxs("div",{className:"admin-wrapper d-flex",children:[e.jsx(te,{}),e.jsxs("div",{className:V?"main-content flex-grow-1 full":"main-content flex-grow-1",id:"main-content",children:[e.jsx(le,{}),e.jsx("main",{className:"p-4",children:e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"d-flex gap-3 align-items-center justify-content-between",children:[e.jsx("h3",{className:"fw-semibold fs-5",children:" Add Product"}),e.jsxs(Y,{to:"",onClick:()=>F(-1),className:"btn btn-sm btn-light",children:[e.jsx("i",{className:"fa fa-arrow-left me-2"})," Go Back"]})]})}),e.jsx("div",{className:"card-body",children:e.jsx("form",{onSubmit:M(J),children:e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"w-100",children:[e.jsxs("div",{className:"upload-img",children:[e.jsx("input",{type:"file",id:"productImage",className:"d-none",accept:"image/*",multiple:!0,onChange:T}),e.jsxs("label",{htmlFor:"productImage",className:"upload-content",children:[e.jsx("i",{className:"fa fa-cloud-upload"}),e.jsxs("p",{className:"mb-0",children:[" ","Click to upload at least 5 images"]}),e.jsx("small",{className:"text-muted",children:"PNG, JPG, JPEG (Max 5MB)"})]})]}),(p.length>0||f.length>0)&&e.jsxs("div",{className:"row mt-3 g-2",children:[p.map((s,a)=>e.jsxs("div",{className:"col-3 position-relative img-wrap",children:[e.jsx("img",{src:s,alt:`Existing ${a+1}`,className:"img-fluid rounded shadow-sm",style:{width:"100%",height:"100px",objectFit:"cover"}}),e.jsx("i",{className:"fas fa-remove",onClick:()=>{const r=p.filter((t,o)=>o!==a);D(r)}})]},`existing-${a}`)),f.map((s,a)=>e.jsxs("div",{className:"col-3 position-relative img-wrap",children:[e.jsx("img",{src:URL.createObjectURL(s),alt:`Preview ${a+1}`,className:"img-fluid rounded shadow-sm",style:{width:"100%",height:"100px",objectFit:"cover"}}),e.jsx("i",{className:"fas fa-remove",onClick:()=>U(a)})]},`new-${a}`))]})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Product Name"}),e.jsx("input",{type:"text",placeholder:"Enter product name",className:`form-control ${l.name_en?"input-error":""}`,...x("name_en",{required:"Product Name is required"})}),l.name_en&&e.jsx("p",{className:"form-error",children:l.name_en.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Category"}),e.jsxs("select",{className:`form-control form-select ${l.categoryId?"input-error":""}`,...x("categoryId",{required:"Category  is required"}),children:[e.jsx("option",{value:"",hidden:!0,children:"Select Category"}),w?.map(s=>e.jsx("option",{value:s._id,children:s.name_en},s._id))]}),l.categoryId&&e.jsx("p",{className:"form-error",children:l.categoryId.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Subcategory"}),e.jsxs("select",{className:`form-control form-select ${l.subCategoryId?"input-error":""}`,...x("subCategoryId",{required:"Sub Category  is required"}),children:[e.jsx("option",{hidden:!0,value:"",children:"Select Sub Category"}),q?.map(s=>e.jsx("option",{value:s._id,children:s.name_en},s._id))]}),l.subCategoryId&&e.jsx("p",{className:"form-error",children:l.subCategoryId.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Calories"}),e.jsx("input",{type:"number",placeholder:"Enter calories",className:`form-control ${l.calories?"input-error":""}`,...x("calories",{required:!1})}),l.calories&&e.jsx("p",{className:"form-error",children:l.calories.message})]}),e.jsxs("div",{className:"col-md-4",children:[e.jsx("label",{className:"form-label",children:"Type"}),e.jsxs("select",{className:`form-control form-select ${l.type?"input-error":""}`,...x("type",{required:"Type is required"}),children:[e.jsx("option",{value:"",hidden:!0,children:"Select Type"}),e.jsx("option",{value:"Veg",children:"Veg"}),e.jsx("option",{value:"Non Veg",children:"Non-Veg"})]}),l.type&&e.jsx("p",{className:"form-error",children:l.type.message})]}),e.jsxs("div",{className:"col-md-12",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx(S,{name:"description_en",control:_,rules:{required:"Description is required",validate:s=>(s?.replace(/<[^>]*>/g,"").trim()).length>0||"Description is required"},render:({field:s})=>e.jsx(oe,{theme:"snow",value:s.value||"",onChange:a=>{s.onChange(a),a.replace(/<[^>]*>/g,"").trim()===""&&s.onChange("")},onBlur:()=>{s.onBlur()},placeholder:"Enter description",className:l.description_en?"input-error":"",style:{height:"130px",marginBottom:"65px"},modules:{toolbar:[[{header:[1,2,3,4,5,6,!1]}],[{font:[]}],[{size:["small",!1,"large","huge"]}],["bold","italic","underline","strike"],[{color:[]},{background:[]}],[{script:"sub"},{script:"super"}],[{list:"ordered"},{list:"bullet"}],[{indent:"-1"},{indent:"+1"}],[{align:[]}],["blockquote","code-block"],["clean"]]}})}),l.description_en&&e.jsx("p",{className:"form-error",style:{marginTop:"75px"},children:l.description_en.message})]}),e.jsxs("div",{className:"col-12",children:[e.jsx("h2",{className:"fs-5 fw-bold",children:"Create Attribute"}),e.jsx("div",{className:"mt-3",children:e.jsxs("div",{className:"row g-3",children:[e.jsxs("div",{className:"col-md-5 multi",children:[e.jsx("label",{className:"form-label",children:"Attribute "}),e.jsx(S,{name:"attributeId",control:_,rules:{required:"Attribute is required"},render:({field:s})=>e.jsx(L,{...s,isMulti:!0,options:y?.map(a=>({value:a._id,label:a.name_en})),placeholder:"Select Attribute",className:l.attributeId?"react-select-error":"",classNamePrefix:"react-select",onChange:a=>s.onChange(a?.map(r=>r.value)||[]),value:y?.filter(a=>s.value?.includes(a._id)).map(a=>({value:a._id,label:a.name_en}))||[]})}),l.attributeId&&e.jsx("p",{className:"form-error",children:l.attributeId.message})]}),e.jsxs("div",{className:"col-md-5 multi",children:[e.jsx("label",{className:"form-label",children:"Value"}),e.jsx(S,{name:"valueId",control:_,rules:{required:"Value is required"},render:({field:s})=>e.jsx(L,{...s,isMulti:!0,options:N?.map(a=>({value:a._id,label:a.name_en})),placeholder:"Select Value",className:l.valueId?"react-select-error":"",classNamePrefix:"react-select",onChange:a=>s.onChange(a?.map(r=>r.value)||[]),value:N?.filter(a=>s.value?.includes(a._id)).map(a=>({value:a._id,label:a.name_en}))||[]})}),l.valueId&&e.jsx("p",{className:"form-error",children:l.valueId.message})]}),e.jsx("div",{className:"col-md-auto pt-4",children:e.jsx("button",{onClick:s=>{s.preventDefault(),O()},className:"comman-btn-main w-100 fs-6 mt-1",children:"Show Combination"})}),m?.length?e.jsx("div",{className:"col-12",children:e.jsxs("div",{className:"card shadow",children:[e.jsx("div",{className:"card-header",children:e.jsx("h3",{className:"fw-semibold fs-5",children:"Attribute"})}),e.jsx("div",{className:"card-body",children:e.jsx("div",{className:"table-responsive shadow-sm rounded bg-white p-3",children:e.jsxs("table",{className:"table table-hover align-middle",children:[e.jsx("thead",{className:"table-light",children:e.jsxs("tr",{children:[e.jsx("th",{children:"S.No"}),e.jsx("th",{children:"Attribute Name"}),e.jsx("th",{children:"Combination"}),e.jsx("th",{children:"Price"}),e.jsx("th",{children:"Discounted Price"}),e.jsx("th",{children:"Quantity"}),e.jsx("th",{className:"text-center",children:"Actions"})]})}),e.jsx("tbody",{children:m?.map((s,a)=>e.jsxs("tr",{children:[e.jsx("td",{children:a+1}),e.jsx("td",{children:s.attributeName}),e.jsx("td",{children:e.jsx("div",{className:"badge bg-main",children:s.valueName})}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"form-control small-width",value:s.price||"",onChange:r=>{const t=[...m];t[a]={...t[a],price:r.target.value},g(t)}})}),e.jsxs("td",{children:[e.jsx("input",{type:"number",className:"form-control small-width",value:s.discountPrice||"",onChange:r=>{const t=[...m];t[a]={...t[a],discountPrice:r.target.value},g(t)}}),Number(s.discountPrice)>=Number(s.price)&&e.jsx("p",{className:"form-error",children:"Discounted price cannot be greater than base price"})]}),e.jsx("td",{children:e.jsx("input",{type:"number",className:"form-control small-width",value:s.quantity||"",onChange:r=>{const t=[...m];t[a]={...t[a],quantity:r.target.value},g(t)}})}),e.jsx("td",{className:"text-center",children:e.jsx("button",{className:"table-btn bg-danger",onClick:r=>{r.preventDefault();const t=m.filter((o,b)=>b!==a);g(t)},children:e.jsx("i",{className:"fa fa-trash"})})})]},s._id))})]})})})]})}):""]})})]}),e.jsx("div",{className:"col-12 mt-4",children:e.jsx("button",{type:"submit",className:"btn comman-btn-main",disabled:P,children:P?e.jsxs(e.Fragment,{children:[e.jsx(ie,{strokeColor:"white",strokeWidth:"5",animationDuration:"0.75",width:"20",visible:!0}),e.jsxs("span",{className:"ms-2",children:[" Wait... ",$,"%"]})]}):"Add"})})]})})})]})})]})]})})}const pe=H.memo(de);export{pe as default};
